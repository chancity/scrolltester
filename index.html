<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/html">
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<meta name="theme-color" content="#936bfb"/>
	<title>Scroll Tester</title>
	<style>
		body{
			margin: 0;
		}
		*{
			box-sizing: border-box;
		}
		button{
			border-width: 1px;
			border-style: solid;
			border-color: rgb(223, 225, 229);
			border-image: initial;
			border-radius: 24px;
			background: white;
			transition: all 0.25s ease-in-out 0s;
			cursor: pointer;
			text-transform: uppercase;
			font-size: 16px;
			outline: none;
			font-weight: 600;
		}
		strong{
			color: green;
		}
		button:hover {
			background-color: black;
			color: white;
			box-shadow: rgba(32, 33, 36, 0.28) 0px 1px 6px 0px;
		}

		.matcard {
			background-color: rgb(255, 255, 255);
			box-shadow: rgba(0, 0, 0, 0.12) 0px 1px 6px, rgba(0, 0, 0, 0.24) 0px 1px 4px;
			width: 100%;
			border-radius: 0.25em;
			padding: 24px;

		}
	</style>
</head>
<body>
<script>
	//if ('serviceWorker' in navigator) {
	//	navigator.serviceWorker.register('/service-worker.js')
	//	.then(function(response) {
//
	//		// Service worker registration done
	//		console.log('Registration Successful', response);
	//	}, function(error) {
	//		// Service worker registration failed
	//		console.log('Registration Failed', error);
	//	})
	//}
	//window.runTest = function() {
	//	var wait = 300;
//
	//	var debounceOptions = {
	//		leading: false,
	//		maxWait: 0,
	//		trailing: true,
	//	};
//
	//	var throttleOptions = {
	//		leading: true,
	//		maxWait: wait,
	//		trailing: true,
	//	};
//
	//	var counter = 0;
//
	//	history.replaceState = createThrottledFunction(history.replaceState, history, wait, debounceOptions);
	//	history.replaceState({data:0},"");
	//	setInterval(function(){history.replaceState({data:history.state.data+1}, "");console.log('history.state.data value is ' + history.state.data);}, 150);
//
	//};
</script>
<div id="root" style="height: 1000vh;display: flex; justify-content: center">
	<div style="display: grid; grid-auto-flow: dense row; position: fixed; width: 100%; grid-gap: 24px; margin-top: 24px; padding-left: 6px;padding-right: 6px; max-width: 1200px;">
		<div style="display: flex; justify-content: space-between; grid-gap: 24px;font-size: 24px;flex-wrap: wrap; text-align: center;" class="matcard">
			<span style="min-width: 250px; margin-bottom: 6px; margin-top: 6px">
				SCROLLPOS: <strong id="scrollpos">0</strong>
			</span>
				<span style="min-width: 250px; margin-bottom: 6px; margin-top: 6px">
				INVOCATIONS: <strong id="invocations">0</strong>
			</span>
				<span style="min-width: 250px; margin-bottom: 6px; margin-top: 6px">
				RUNTIME: <strong id="runTime">0</strong> ms
			</span>
				<span style="min-width: 250px; margin-bottom: 6px; margin-top: 6px">
				THROTTLED:
				<input type="checkbox" id="checkbox" checked="yes" onchange="window.checkChecked">
			</span>
		</div>

		<div style="display: flex; flex-direction: column; padding: 24px;" class="matcard">
			<button style="padding: 12px;margin-bottom: 12px;" onclick="window.tester.tearDown();window.tester.setup(window.addToLocalStorage)">
				LocalStorage
			</button>
			<button style="padding: 12px;margin-bottom: 12px;" onclick="window.tester.tearDown();window.tester.setup(window.addToHistoryState)">
				History.replaceState
			</button>
		</div>
	</div>
</div>
<script>
	var key = 'scrollpos';
	window.addToLocalStorage = function(data) {
		window.localStorage.setItem(key, JSON.stringify(data));
	};

	window.addToHistoryState = function(data) {
		window.history.replaceState(data, "");
	};

	window.initTest = function () {
		var funcRef = undefined;
		var funcRefs = undefined;
		var last_known_scroll_position = 0;
		var invocations = 0;
		var startTime = 0;
		var autoScroller = undefined;
		var rootEl = document.getElementById('root')
		var checkbox = document.getElementById("checkbox");
		var throttled = true;

		checkbox.addEventListener( 'change', function() {
			throttled = this.checked;

			if(funcRefs) {
				_tearDown();
				_setup(funcRefs.originalFunc);
			}

		});

		function setElementData() {
			var currTime = testStartTime = new Date().getTime();
			var runTime = startTime === 0 ? 0 : currTime - startTime;

			document.getElementById("scrollpos").innerHTML = last_known_scroll_position;
			document.getElementById("invocations").innerHTML = invocations;
			document.getElementById("runTime").innerHTML = runTime;
		}

		setInterval(setElementData, 50);

		function toDataObj(scrollpos) {
			return {
				data: scrollpos
			}
		}

		function scrollHandler(func) {
			if(typeof func !== 'function'){
				throw 'argument must be a function'
			}

			funcRef = function (e) {
				last_known_scroll_position = window.scrollY;
				var data = toDataObj(last_known_scroll_position);
				func(data);
				invocations++;
			};

			var wait = 300;

			var debounceOptions = {
				leading: false,
				maxWait: 0,
				trailing: true,
			};

			return {
				throttledFunc: createThrottledFunction(funcRef, this,wait,debounceOptions),
				func: funcRef,
				originalFunc: func
			};
		}
		function _setup(func) {
			if(typeof funcRef === 'undefined') {
				funcRefs = scrollHandler(func);
				funcRef =  throttled ? funcRefs.throttledFunc : funcRefs.func;

				window.addEventListener('scroll', funcRef);
				startTime = new Date().getTime();
				var lastScroll = 0;
				autoScroller = setInterval(function(){
					var newScroll = lastScroll === 0 ? rootEl.offsetHeight : 0;

					window.scrollTo({
						top: newScroll,
						left: 0,
						behavior: 'smooth'
					});
					lastScroll = newScroll;
				}, 1200);


			} else {
				console.log('test already running')
			}
		}

		function _tearDown() {
			if(typeof funcRef === 'function') {
				window.removeEventListener('scroll', funcRef);
				clearInterval(autoScroller);
				funcRef = undefined;
				invocations = 0;
				startTime = 0;
			} else {
				console.log('no test running')
			}
		}
		//tear down
		return {
			setup: function (func){
				_setup(func);
			},
			tearDown: function () {
				_tearDown();
			}
		}
	};
	function checkChecked(e){
		console.log(e)
	}
	window.tester = window.initTest();
</script>
<script type="text/javascript" src="runtime.bundle.js"></script><script type="text/javascript" src="create-throttled-function.bundle.js"></script><script type="text/javascript" src="product-finding-methods.bundle.js"></script></body>
</html>
